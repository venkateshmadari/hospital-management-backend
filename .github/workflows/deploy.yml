name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      # 2Ô∏è‚É£ Get the commit author email
      - name: Get Commit Author Email
        run: |
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          echo "Commit Author: $AUTHOR_EMAIL"
          echo "AUTHOR_EMAIL=$AUTHOR_EMAIL" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Check authorized user
      - name: Check Authorized Email
        run: |
          if [[ "$AUTHOR_EMAIL" != "venkateshmadari07@gmail.com" ]]; then
            echo "‚ùå Unauthorized user: $AUTHOR_EMAIL"
            exit 1
          fi
        shell: bash

      # 4Ô∏è‚É£ Set up SSH for EC2
      - name: Set up SSH key for EC2
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # 5Ô∏è‚É£ Deploy to EC2
      - name: Deploy to EC2
        run: |
          ssh -t -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=10 \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            
            set -e  # Exit if any command fails

            echo "üìÇ Changing directory..."
            cd /home/ubuntu/hospital-management-backend || { echo "‚ùå Failed to cd"; exit 1; }

            echo "‚¨áÔ∏è Pulling latest changes..."
            git fetch --all
            git reset --hard origin/main

            echo "üì¶ Installing dependencies..."
            npm ci --silent || { echo "‚ùå npm install failed"; exit 1; }

            # Ensure Prisma CLI is installed
            if ! npx prisma --version &>/dev/null; then
              echo "üîß Installing Prisma..."
              npm install prisma --save-dev --silent || { echo "‚ùå Prisma install failed"; exit 1; }
            fi

            echo "üõ†Ô∏è Running Prisma migrations..."
            npx prisma migrate deploy || { echo "‚ùå Prisma migrate failed"; exit 1; }
            npx prisma generate || { echo "‚ùå Prisma generate failed"; exit 1; }

            echo "üöÄ Restarting PM2..."
            if ! pm2 restart my-backend 2>/dev/null; then
              echo "‚ö†Ô∏è PM2 restart failed, starting new process..."
              pm2 start server.js --name my-backend
            fi
            pm2 save

            echo "‚úÖ Deployment complete!"
          EOF
